#!/usr/bin/python

import os, random, datetime
import Conn

files = ""
i = 0
j = 0
now = datetime.datetime.now()

def Scan(url,verbose,outdir):

	global files, i, j, options

	if outdir == None:
	        rnd = str(random.randint(1, 99999))
	        outdir = os.path.abspath("htexploit-" + rnd.zfill(5)) # Create a variable including a 5-digit random number
	        if verbose == True:
	                print "[+] Output not specified, setting '" + outdir + "'"
	else:
	        outdir = os.path.abspath(outdir)

	if os.path.exists(outdir + "/data"):
		if verbose == True:
			print "[+] Output Dir Already Exists\n"
	else:
		if verbose == True:
			print "[+] Creating Output Dir\n"
		try:
			os.makedirs(outdir + "/data")
			os.makedirs(outdir + "/res")

		except:
			print "[-] Error creating output directory, do you have permissions?"
			sys.exit("[-] Exiting.\n")

		try:
			# Copy logo PNG file
			origfile = file(os.getcwd() + "/res/reporting/logo.png","r")
			destfile = file(outdir + "/res/logo.png","w")
			destfile.writelines(origfile)
			# Copy CSS file
			origfile = file(os.getcwd() + "/res/reporting/style.css","r")
			destfile = file(outdir + "/res/style.css","w")
			destfile.writelines(origfile)
			repfile = file(outdir + "/HTExploit-report.html","w")
			origfile = file(os.getcwd() + "/res/reporting/header.html","r")
			repfile.writelines(origfile)
			# Insert scan information
			repfile.writelines("<h4>Scan date: " + now.strftime("%Y-%m-%d %H:%M") + "</h4>")
			repfile.writelines("<h4>Scanned URL: <a href='" + url + "' target='_blank'>" + url + "</a></h4>")
			repfile.writelines("<table class='bordered'><thead>")
			repfile.writelines("<tr><th>ID</th><th>Name</th></tr></thead>")
		except:
			print "[-] Error creating report files, do you have permissions?"

	try:
		files = open(os.getcwd()+"/res/FullList","r")
	except:
		print " **ERROR** Unable to open './res/FullList' file. Exiting\n"

	for line in files:
	        conn_res = Conn.Connect(2,url + "/" + line)
	        if conn_res == 1: #If there's an error in the connection
	                print "[-] Connection error.\nCheck if URL is valid and target is up and listening on the specified port.\n"
			break
	        elif (conn_res == 404 or conn_res == 501): #If file was not found (exploit didn't work)
			if verbose == True:
				print "[-] File '" + line.strip() + "' couldn't be retrieved"
		else:
			i = i + 1
			if verbose == True:
				print "[+] File '" + line.strip() + "' was downloaded"
			try:
				outfile = file(outdir + "/data/" + line.strip() + ".html","w") #Save the files as HTML files, for easy reading
				outfile.writelines(conn_res)
				repfile.writelines("<TR><TD>")
				repfile.writelines(str(i))
				repfile.writelines("</TD><TD>")
				repfile.writelines("<a href='data/" + line.strip() + ".html' target='_blank'>" + url + "/" + line.strip() + "</a><br />")
				repfile.writelines("</TD></TR>")

			except:
				pass
				print "I/O error on writing output file, do you have permissions?"
		j = j + 1

	origfile = file(os.getcwd() + "/res/reporting/footer.html","r")
	repfile.writelines("\n")
	repfile.writelines(origfile)

	print 
	print "[+] Full Scan Completed."
	print "[+] " + str(i) + " files were downloaded, out of " + str(j) + " (" + str(i * 100 / j) + "% success rate). Report was saved in '" + outdir + "'\n"
